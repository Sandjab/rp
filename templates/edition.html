<!DOCTYPE html>
<html lang="fr" data-theme="light">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>{{EDITION_TITLE}} — {{EDITION_DATE}}</title>
<meta name="description" content="Revue de presse quotidienne — Tech, IA, Sciences, Startups">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#FAFAF8;--card:#FFFFFF;--text:#1A1A1A;--text-2:#6B6B6B;
  --accent:#E63946;--border:#E5E5E3;
  --font-h:'Instrument Serif',serif;--font-b:'Inter',sans-serif;--font-m:'JetBrains Mono',monospace;
  --ease:cubic-bezier(0.25,0.46,0.45,0.94);
}
[data-theme="dark"]{
  --bg:#0F0F0F;--card:#1A1A1A;--text:#EDEDEB;--text-2:#999999;
  --accent:#FF6B6B;--border:#2A2A2A;
}
html{font-size:16px;-webkit-text-size-adjust:100%}
body{
  font-family:var(--font-b);color:var(--text);background:var(--bg);
  min-height:100vh;transition:background .3s var(--ease),color .3s var(--ease);
  overflow-x:hidden;
}
a{color:inherit;text-decoration:none}

/* MASTHEAD */
.masthead{
  padding:clamp(1.5rem,4vw,3rem) clamp(1rem,5vw,4rem);
  border-bottom:2px solid var(--text);
  display:flex;justify-content:space-between;align-items:baseline;
  flex-wrap:wrap;gap:1rem;
}
.masthead h1{
  font-family:var(--font-h);font-size:clamp(2rem,5vw,3.5rem);
  font-weight:400;letter-spacing:-0.02em;line-height:1;
}
.masthead-meta{
  font-family:var(--font-m);font-size:clamp(0.7rem,1.2vw,0.85rem);
  color:var(--text-2);display:flex;align-items:center;gap:1.5rem;
}
.theme-toggle{
  background:none;border:1px solid var(--border);color:var(--text);
  font-family:var(--font-m);font-size:0.8rem;padding:0.4rem 0.8rem;
  cursor:pointer;transition:border-color .2s;
}
.theme-toggle:hover{border-color:var(--text)}

/* BREAKING */
.breaking{
  background:var(--accent);color:#fff;
  padding:0.8rem clamp(1rem,5vw,4rem);
  font-family:var(--font-m);font-size:0.85rem;
  display:none;align-items:center;gap:0.8rem;
}
.breaking.active{display:flex}
.breaking-dot{
  width:8px;height:8px;border-radius:50%;background:#fff;
  animation:pulse 2s infinite;flex-shrink:0;
}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.3}}

/* FILTER BAR */
.filter-bar{
  padding:1rem clamp(1rem,5vw,4rem);
  display:flex;align-items:center;gap:0.8rem;flex-wrap:wrap;
  border-bottom:1px solid var(--border);
}
.filter-pill{
  font-family:var(--font-m);font-size:0.75rem;
  padding:0.35rem 0.75rem;border:1px solid var(--border);
  background:transparent;color:var(--text-2);cursor:pointer;
  transition:all .2s;text-transform:uppercase;letter-spacing:0.05em;
}
.filter-pill:hover,.filter-pill.active{
  color:var(--text);border-color:var(--text);
}
.view-toggle{
  margin-left:auto;background:none;border:1px solid var(--border);
  color:var(--text-2);font-family:var(--font-m);font-size:0.75rem;
  padding:0.35rem 0.75rem;cursor:pointer;transition:all .2s;
}
.view-toggle:hover{border-color:var(--text);color:var(--text)}

/* CARD CONTAINER */
.card-viewport{
  position:relative;
  padding:clamp(1.5rem,4vw,3rem) clamp(1rem,5vw,4rem);
  min-height:60vh;overflow:hidden;
}
.card-stack{position:relative;max-width:720px;margin:0 auto}
.card{
  position:absolute;top:0;left:0;right:0;
  background:var(--card);border:1px solid var(--border);
  padding:clamp(1.5rem,3vw,2.5rem);
  opacity:0;pointer-events:none;
  transition:transform .45s var(--ease),opacity .35s var(--ease);
  touch-action:pan-y pinch-zoom;user-select:none;
  will-change:transform;
}
.card.active{
  opacity:1;pointer-events:auto;position:relative;
  animation:cardIn .4s var(--ease) both;
}
@keyframes cardIn{from{opacity:0;transform:scale(0.97)}to{opacity:1;transform:scale(1)}}
.card.exit-left{transform:translateX(-120%) rotate(-4deg);opacity:0}
.card.exit-right{transform:translateX(120%) rotate(4deg);opacity:0}

/* CARD CONTENT */
.card-tags{display:flex;gap:0.5rem;margin-bottom:1.2rem;flex-wrap:wrap}
.tag-pill{
  font-family:var(--font-m);font-size:0.65rem;
  padding:0.25rem 0.6rem;text-transform:uppercase;
  letter-spacing:0.08em;transition:opacity .2s;
}
.tag-pill:hover{opacity:1!important}
.card-title{
  font-family:var(--font-h);font-size:clamp(1.5rem,3.5vw,2.2rem);
  font-weight:400;line-height:1.2;margin-bottom:0.8rem;
  letter-spacing:-0.01em;
}
.card-source{
  font-family:var(--font-m);font-size:0.75rem;color:var(--text-2);
  margin-bottom:1.2rem;text-transform:uppercase;letter-spacing:0.05em;
}
.card-summary{
  font-size:clamp(0.95rem,1.5vw,1.05rem);line-height:1.7;
  color:var(--text);margin-bottom:1.5rem;
}
.card-context{
  overflow:hidden;max-height:0;transition:max-height .4s var(--ease);
  margin-bottom:1rem;
}
.card-context.open{max-height:500px}
.card-context-inner{
  padding:1rem;background:var(--bg);border-left:3px solid var(--accent);
  font-size:0.9rem;line-height:1.7;color:var(--text-2);margin-bottom:1rem;
}
.context-toggle{
  font-family:var(--font-m);font-size:0.75rem;color:var(--accent);
  background:none;border:none;cursor:pointer;
  display:flex;align-items:center;gap:0.4rem;margin-bottom:1.2rem;
}
.context-toggle .arrow{
  display:inline-block;transition:transform .3s;font-size:0.6rem;
}
.context-toggle.open .arrow{transform:rotate(90deg)}
.card-link{
  font-family:var(--font-m);font-size:0.8rem;
  color:var(--accent);display:inline-flex;align-items:center;gap:0.4rem;
  transition:gap .2s;
}
.card-link:hover{gap:0.8rem}

/* NAVIGATION */
.card-nav{
  display:flex;justify-content:center;align-items:center;
  gap:1.5rem;padding:1.5rem 0;max-width:720px;margin:0 auto;
}
.nav-btn{
  background:none;border:1px solid var(--border);
  color:var(--text);width:40px;height:40px;
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;transition:border-color .2s;font-size:1.2rem;
}
.nav-btn:hover{border-color:var(--text)}
.nav-btn:disabled{opacity:0.3;cursor:default}
.card-counter{
  font-family:var(--font-m);font-size:0.85rem;color:var(--text-2);
  min-width:60px;text-align:center;
  position:relative;overflow:hidden;height:1.2em;
}
.counter-num{
  display:inline-block;transition:transform .3s var(--ease);
}
.dots{display:flex;gap:6px;align-items:center}
.dot{
  width:6px;height:6px;border-radius:50%;background:var(--border);
  cursor:pointer;transition:all .25s var(--ease);
}
.dot.active{
  width:10px;height:10px;background:var(--accent);
}

/* GRID VIEW */
.grid-view{
  display:none;
  grid-template-columns:repeat(auto-fill,minmax(320px,1fr));
  gap:1.5rem;padding:clamp(1.5rem,4vw,3rem) clamp(1rem,5vw,4rem);
  max-width:1200px;margin:0 auto;
}
.grid-view.active{display:grid}
.grid-card{
  background:var(--card);border:1px solid var(--border);
  padding:1.5rem;transition:border-color .2s;
}
.grid-card:hover{border-color:var(--text)}
.grid-card .card-title{font-size:clamp(1.1rem,2vw,1.4rem)}
.grid-card .card-summary{
  font-size:0.9rem;line-height:1.6;
  display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;
}

/* FOOTER */
.edition-footer{
  border-top:2px solid var(--text);
  padding:clamp(1.5rem,4vw,2rem) clamp(1rem,5vw,4rem);
  display:flex;justify-content:space-between;align-items:center;
  flex-wrap:wrap;gap:1rem;
  font-family:var(--font-m);font-size:0.75rem;color:var(--text-2);
}
.footer-nav{display:flex;gap:1.5rem}
.footer-nav a{transition:color .2s}
.footer-nav a:hover{color:var(--text)}

/* REDUCED MOTION */
@media(prefers-reduced-motion:reduce){
  *,*::before,*::after{
    animation-duration:0.01ms!important;animation-iteration-count:1!important;
    transition-duration:0.01ms!important;
  }
}

/* SWIPE HINT — mobile only */
.swipe-hint{
  display:none;text-align:center;
  font-family:var(--font-m);font-size:0.7rem;color:var(--text-2);
  padding:0.5rem 0 0;opacity:0;transition:opacity .6s;
}
.swipe-hint.visible{opacity:1}
.swipe-hint span{display:inline-block;animation:swipeHint 2s var(--ease) 2}
@keyframes swipeHint{
  0%,100%{transform:translateX(0)}
  30%{transform:translateX(-12px)}
  60%{transform:translateX(8px)}
}

/* MOBILE */
@media(max-width:640px){
  .masthead{flex-direction:column;gap:0.5rem}
  .masthead-meta{gap:0.8rem;flex-wrap:wrap}
  .card{padding:1.2rem}
  .card-viewport{min-height:auto;padding:1rem}
  .card-title{font-size:clamp(1.3rem,5vw,1.8rem)}
  .card-summary{font-size:0.95rem;line-height:1.6}
  .filter-bar{
    gap:0.5rem;padding:0.8rem 1rem;
    overflow-x:auto;flex-wrap:nowrap;-webkit-overflow-scrolling:touch;
  }
  .filter-pill{flex-shrink:0;padding:0.5rem 0.9rem;font-size:0.7rem}
  .nav-btn{width:48px;height:48px;font-size:1.4rem}
  .card-nav{gap:1rem;padding:1rem 0}
  .dots{display:none}
  .swipe-hint{display:block}
  .grid-view{grid-template-columns:1fr}
  .grid-card{padding:1.2rem}
  .context-toggle{padding:0.3rem 0;font-size:0.8rem}
  .card-link{font-size:0.85rem;padding:0.2rem 0}
  .breaking{font-size:0.75rem;padding:0.6rem 1rem}
}
</style>
</head>
<body>

<header class="masthead">
  <h1>{{EDITION_TITLE}}</h1>
  <div class="masthead-meta">
    <span>{{EDITION_DATE_DISPLAY}}</span>
    <span>No. {{EDITION_NUMBER}}</span>
    <button class="theme-toggle" onclick="toggleTheme()" aria-label="Basculer le theme">Light</button>
  </div>
</header>

<div class="breaking" id="breaking">
  <span class="breaking-dot"></span>
  <span id="breaking-text"></span>
</div>

<div class="filter-bar">
  <button class="filter-pill active" data-filter="all">Tous</button>
  {{FILTER_PILLS}}
  <button class="view-toggle" onclick="toggleView()">Grille</button>
</div>

<section class="card-viewport" id="cardViewport">
  <div class="card-stack" id="cardStack">
    {{CARDS}}
  </div>
  <nav class="card-nav" id="cardNav">
    <button class="nav-btn" id="prevBtn" onclick="navigate(-1)" aria-label="Precedent">&#8592;</button>
    <div class="card-counter"><span class="counter-num" id="counterNum">1</span> / <span id="totalNum">0</span></div>
    <div class="dots" id="dots"></div>
    <button class="nav-btn" id="nextBtn" onclick="navigate(1)" aria-label="Suivant">&#8594;</button>
  </nav>
  <div class="swipe-hint" id="swipeHint"><span>&#8592; swiper pour naviguer &#8594;</span></div>
</section>

<section class="grid-view" id="gridView">
  {{GRID_CARDS}}
</section>

<footer class="edition-footer">
  <span>Genere par Claude — {{GENERATION_TIME}}</span>
  <nav class="footer-nav">
    {{FOOTER_NAV}}
  </nav>
</footer>

<script>
(function(){
  "use strict";

  const articles = {{ARTICLES_JSON}};

  // State
  let current = 0;
  let filtered = articles.map((_,i) => i);
  let isGrid = false;
  let startX = 0;
  let deltaX = 0;
  let isDragging = false;

  const stack = document.getElementById('cardStack');
  const viewport = document.getElementById('cardViewport');
  const cardNav = document.getElementById('cardNav');
  const gridView = document.getElementById('gridView');
  const counterNum = document.getElementById('counterNum');
  const totalNum = document.getElementById('totalNum');
  const dotsEl = document.getElementById('dots');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');

  // Theme
  function initTheme(){
    const saved = localStorage.getItem('rp-theme');
    const prefer = window.matchMedia('(prefers-color-scheme:dark)').matches ? 'dark' : 'light';
    const theme = saved || prefer;
    document.documentElement.setAttribute('data-theme', theme);
    updateToggleLabel(theme);
  }
  window.toggleTheme = function(){
    const current = document.documentElement.getAttribute('data-theme');
    const next = current === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', next);
    localStorage.setItem('rp-theme', next);
    updateToggleLabel(next);
  };
  function updateToggleLabel(theme){
    document.querySelector('.theme-toggle').textContent = theme === 'dark' ? 'Dark' : 'Light';
  }

  // Breaking news
  const breaking = articles.find(a => a.is_breaking);
  if(breaking){
    document.getElementById('breaking').classList.add('active');
    document.getElementById('breaking-text').textContent = breaking.title;
  }

  // Filters
  document.querySelectorAll('.filter-pill').forEach(btn => {
    btn.addEventListener('click', function(){
      document.querySelectorAll('.filter-pill').forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      const f = this.dataset.filter;
      if(f === 'all') filtered = articles.map((_,i) => i);
      else filtered = articles.reduce((acc,a,i) => { if(a.topics.includes(f)) acc.push(i); return acc; }, []);
      current = 0;
      showCard(0);
      buildDots();
      renderGrid();
    });
  });

  // Cards
  function showCard(idx){
    if(filtered.length === 0) return;
    current = Math.max(0, Math.min(idx, filtered.length - 1));
    const cards = stack.querySelectorAll('.card');
    cards.forEach(c => {
      c.classList.remove('active','exit-left','exit-right');
      c.style.transform = '';
    });
    const activeCard = stack.querySelector(`[data-index="${filtered[current]}"]`);
    if(activeCard) activeCard.classList.add('active');
    counterNum.textContent = current + 1;
    totalNum.textContent = filtered.length;
    prevBtn.disabled = current === 0;
    nextBtn.disabled = current === filtered.length - 1;
    updateDots();
  }

  window.navigate = function(dir){
    const prev = current;
    const next = current + dir;
    if(next < 0 || next >= filtered.length) return;
    const prevCard = stack.querySelector(`[data-index="${filtered[prev]}"]`);
    if(prevCard) prevCard.classList.add(dir > 0 ? 'exit-left' : 'exit-right');
    current = next;
    setTimeout(() => showCard(current), 50);
  };

  // Swipe — with pointer capture for reliable touch
  let activePointerId = null;
  const swipeThreshold = () => Math.min(80, window.innerWidth * 0.2);

  function onPointerDown(e){
    if(isGrid) return;
    const card = e.target.closest('.card.active');
    if(!card) return;
    // Ignore multi-touch (pinch-zoom etc)
    if(activePointerId !== null) return;
    activePointerId = e.pointerId;
    isDragging = true;
    startX = e.clientX;
    deltaX = 0;
    card.style.transition = 'none';
    card.setPointerCapture(e.pointerId);
  }
  function onPointerMove(e){
    if(!isDragging || e.pointerId !== activePointerId) return;
    deltaX = e.clientX - startX;
    const card = stack.querySelector('.card.active');
    if(!card) return;
    const progress = Math.min(Math.abs(deltaX) / (window.innerWidth * 0.45), 1);
    const opacity = 1 - progress * 0.4;
    card.style.transform = `translateX(${deltaX}px) rotate(${deltaX * 0.02}deg)`;
    card.style.opacity = opacity;
    // Prevent vertical scroll while swiping horizontally
    if(Math.abs(deltaX) > 10) e.preventDefault();
  }
  function onPointerUp(e){
    if(!isDragging || e.pointerId !== activePointerId) return;
    isDragging = false;
    activePointerId = null;
    const card = stack.querySelector('.card.active');
    if(!card) return;
    card.style.transition = '';
    card.style.opacity = '';
    if(Math.abs(deltaX) > swipeThreshold()){
      navigate(deltaX < 0 ? 1 : -1);
    } else {
      card.style.transform = '';
    }
  }
  viewport.addEventListener('pointerdown', onPointerDown);
  viewport.addEventListener('pointermove', onPointerMove);
  viewport.addEventListener('pointerup', onPointerUp);
  viewport.addEventListener('pointercancel', onPointerUp);

  // Keyboard
  document.addEventListener('keydown', function(e){
    if(isGrid) return;
    if(e.key === 'ArrowRight') navigate(1);
    else if(e.key === 'ArrowLeft') navigate(-1);
  });

  // Dots
  function buildDots(){
    dotsEl.innerHTML = '';
    const max = Math.min(filtered.length, 12);
    for(let i = 0; i < max; i++){
      const d = document.createElement('span');
      d.className = 'dot' + (i === current ? ' active' : '');
      d.addEventListener('click', () => showCard(i));
      dotsEl.appendChild(d);
    }
  }
  function updateDots(){
    dotsEl.querySelectorAll('.dot').forEach((d,i) => {
      d.classList.toggle('active', i === current);
    });
  }

  // Context toggle
  window.toggleContext = function(btn){
    const ctx = btn.nextElementSibling;
    const open = ctx.classList.toggle('open');
    btn.classList.toggle('open', open);
    btn.querySelector('.ctx-label').textContent = open ? 'Masquer le contexte' : 'Contexte approfondi';
  };

  // Grid view
  window.toggleView = function(){
    isGrid = !isGrid;
    viewport.style.display = isGrid ? 'none' : '';
    cardNav.style.display = isGrid ? 'none' : '';
    gridView.classList.toggle('active', isGrid);
    document.querySelector('.view-toggle').textContent = isGrid ? 'Cards' : 'Grille';
  };

  function renderGrid(){
    const cards = gridView.querySelectorAll('.grid-card');
    cards.forEach(c => {
      const idx = parseInt(c.dataset.index);
      c.style.display = filtered.includes(idx) ? '' : 'none';
    });
  }

  // Swipe hint — show on mobile, hide after first swipe
  const swipeHint = document.getElementById('swipeHint');
  let hintDismissed = false;
  function showSwipeHint(){
    if(hintDismissed || !swipeHint) return;
    if(window.innerWidth <= 640){
      swipeHint.classList.add('visible');
    }
  }
  function dismissSwipeHint(){
    if(hintDismissed) return;
    hintDismissed = true;
    if(swipeHint) swipeHint.classList.remove('visible');
  }
  // Dismiss on first navigation
  const origNavigate = window.navigate;
  window.navigate = function(dir){
    dismissSwipeHint();
    return origNavigate(dir);
  };

  // Init
  initTheme();
  showCard(0);
  buildDots();
  setTimeout(showSwipeHint, 800);
})();
</script>
</body>
</html>
